name: Update GCP Always Free Article

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0 1 * *"   # ÊØéÊúà1Êó• 00:05 UTCÔºàÊó•Êú¨ÊôÇÈñì 09:05Ôºâ

env:
  APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
  APIFY_ACTOR_ID_GCP: ${{ secrets.APIFY_ACTOR_ID_GCP }}

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Checkout
      # --------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # --------------------------
      # 2. Apify Actor ÂÆüË°å
      # --------------------------
      - name: Run Apify Actor (GCP)
        id: run_actor
        run: |
          echo "Starting Apify actor..."
          RUN_JSON=$(curl -s -X POST "https://api.apify.com/v2/acts/${APIFY_ACTOR_ID_GCP}/runs?token=${APIFY_TOKEN}")
          RUN_ID=$(echo "$RUN_JSON" | jq -r '.data.id')
          echo "Run ID = $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # --------------------------
      # 3. Actor ÂÆå‰∫ÜÂæÖ„Å°
      # --------------------------
      - name: Wait for Actor Run to finish
        run: |
          echo "Waiting for actor to finish..."
          for i in {1..40}; do
            STATUS=$(curl -s "https://api.apify.com/v2/actor-runs/${RUN_ID}?token=${APIFY_TOKEN}" | jq -r '.data.status')
            echo "Status: $STATUS"

            if [[ "$STATUS" == "SUCCEEDED" ]]; then
              break
            fi
            sleep 5
          done

      # --------------------------
      # 4. KV „Åã„ÇâÂá∫Âäõ JSON „ÇíÂèñÂæó
      # --------------------------
      - name: Download Actor Output (JSON)
        run: |
          curl -s \
            "https://api.apify.com/v2/actor-runs/${RUN_ID}/key-value-stores/ALWAYS_FREE_GCP/records/ALWAYS_FREE_GCP?disableRedirect=true&token=${APIFY_TOKEN}" \
            -o data.json

          echo "Downloaded JSON:"
          cat data.json

      # --------------------------
      # 5. Markdown ÁîüÊàêÔºàZennÁî® FrontMatter ‰ªò„ÅçÔºâ
      # --------------------------
      - name: Generate Markdown
        run: |
          mkdir -p articles

          # ===== FrontMatterÔºàZennÂøÖÈ†àÔºâ =====
          cat << 'EOF' > articles/gcp-always-free.md
---
title: "Google Cloud Always Free"
emoji: "‚òÅÔ∏è"
type: "tech"
topics: ["gcp", "free-tier"]
published: true
---

# Google Cloud Always Free

EOF

          echo "ÊúÄÁµÇÊõ¥Êñ∞Êó•: $(jq -r '.fetchedAt' data.json)" >> articles/gcp-always-free.md
          echo "" >> articles/gcp-always-free.md

          # ===== Êú¨Êñá„É´„Éº„Éó =====
          jq -c '.items[]' data.json | while read item; do
            TITLE=$(echo "$item" | jq -r '.title')
            DESC=$(echo "$item" | jq -r '.description')
            FREE=$(echo "$item" | jq -r '.free_tier')
            LINK=$(echo "$item" | jq -r '.link')

            cat <<EOF >> articles/gcp-always-free.md
## üåü ${TITLE}
${DESC}
**ÁÑ°ÊñôÊû†**Ôºö${FREE}  
${LINK}

---
EOF
          done

      # --------------------------
      # 6. Commit & Push
      # --------------------------
      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add articles/gcp-always-free.md
          git commit -m "Update GCP Always Free article" || echo "No changes to commit"
          git push
