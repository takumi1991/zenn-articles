name: Update GCP Always Free Article

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0 1 * *"   # ÊØéÊúà1Êó• 09:05 JST

env:
  APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
  APIFY_ACTOR_ID_GCP: ${{ secrets.APIFY_ACTOR_ID_GCP }}

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run Apify Actor (GCP)
        id: run_actor
        run: |
          RUN_JSON=$(curl -s -X POST "https://api.apify.com/v2/acts/${APIFY_ACTOR_ID_GCP}/runs?token=${APIFY_TOKEN}")
          RUN_ID=$(echo "$RUN_JSON" | jq -r '.data.id')
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      - name: Wait for Run
        run: |
          for i in {1..40}; do
            STATUS=$(curl -s "https://api.apify.com/v2/actor-runs/${RUN_ID}?token=${APIFY_TOKEN}" | jq -r '.data.status')
            echo "Status: $STATUS"
            if [[ "$STATUS" == "SUCCEEDED" ]]; then break; fi
            sleep 5
          done

      - name: Download JSON
        run: |
          curl -s \
            "https://api.apify.com/v2/actor-runs/${RUN_ID}/key-value-stores/GCP_ALWAYS_FREE/records/GCP_ALWAYS_FREE?disableRedirect=true&token=${APIFY_TOKEN}" \
            -o data.json

      - name: Build Markdown
        run: |
          TARGET="articles/gcp-always-free.md"

          # FrontMatter „ÅÆ„ÅøÊäΩÂá∫
          awk '
            NR==1, /^---$/ { print; next }
            /^---$/ { c++; if (c==2) next }
            c<2
          ' "$TARGET" > tmp.md

          echo "" >> tmp.md
          echo "# Google Cloud Always Free" >> tmp.md
          echo "" >> tmp.md
          echo "ÊúÄÁµÇÊõ¥Êñ∞Êó•: $(jq -r '.fetchedAt' data.json)" >> tmp.md
          echo "" >> tmp.md

          jq -c '.items[]' data.json | while read item; do
            TITLE=$(echo "$item" | jq -r '.title')
            DESC=$(echo "$item" | jq -r '.description')
            FREE=$(echo "$item" | jq -r '.free_tier')
            LINK=$(echo "$item" | jq -r '.link')

cat <<EOF >> tmp.md
## üåü ${TITLE}
${DESC}

**ÁÑ°ÊñôÊû†**Ôºö${FREE}  
[Ë©≥Á¥∞„É™„É≥„ÇØ](${LINK})

----
EOF

          done

          mv tmp.md "$TARGET"

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add articles/gcp-always-free.md
          git commit -m "Update GCP Always Free article" || echo "No changes"
          git push
