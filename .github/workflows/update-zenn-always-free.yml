# .github/workflows/update-zenn-always-free.yml
name: Update Zenn "Always Free" article

on:
  schedule:
    - cron: "0 0 * * *"   # æ¯Žæ—¥ 00:00 UTCï¼ˆJST 09:00ã”ã‚ã«åæ˜ ï¼‰
  workflow_dispatch:

permissions:
  contents: write   # ã‚³ãƒŸãƒƒãƒˆ/Pushã«å¿…è¦

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    env:
      REGION: ap-northeast-1
      FREE_TIER_API: https://example.com/aws/free-tier.json    # â† ã‚ãªãŸã®APIã«ç½®ãæ›ãˆã¦ãã ã•ã„
      OUT_PATH: zenn/articles/aws-always-free-list.md
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Zenn directories exist
        run: |
          mkdir -p zenn/articles zenn/books zenn/images
          touch zenn/books/.keep
          touch zenn/images/.keep

      - name: Fetch Always Free JSON
        run: |
          curl -sS "${FREE_TIER_API}" -o free-tier.json
          test -s free-tier.json

      - name: Generate Markdown for Zenn
        run: |
          echo "---" > "${OUT_PATH}"
          echo "title: AWSã€Œå¸¸æ™‚ç„¡æ–™æž ã€ä¸€è¦§ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰" >> "${OUT_PATH}"
          echo "emoji: ðŸ†“" >> "${OUT_PATH}"
          echo "type: tech" >> "${OUT_PATH}"
          echo "topics: [aws, free-tier, cost]" >> "${OUT_PATH}"
          echo "published: true" >> "${OUT_PATH}"
          echo "---" >> "${OUT_PATH}"
          echo "" >> "${OUT_PATH}"
          echo "> æœ€çµ‚æ›´æ–°: $(date -u '+%Y-%m-%dT%H:%M:%SZ') (UTC)" >> "${OUT_PATH}"
          echo "" >> "${OUT_PATH}"
          echo "## å¸¸æ™‚ç„¡æ–™æž ï¼ˆAlways Freeï¼‰ä¸€è¦§" >> "${OUT_PATH}"
          echo "" >> "${OUT_PATH}"
          echo "| ã‚µãƒ¼ãƒ“ã‚¹ | ç„¡æ–™ä¸Šé™ | ä¸»ãªæ³¨æ„ç‚¹ |" >> "${OUT_PATH}"
          echo "|---|---|---|" >> "${OUT_PATH}"

          # ä¾‹ï¼šjqã§å¸¸æ™‚ç„¡æ–™æž ã®ã¿æŠ½å‡ºã—ã¦è¡¨åŒ–ï¼ˆAPIã®æ§‹é€ ã«åˆã‚ã›ã¦ç·¨é›†ï¼‰
          jq -r '
            .services[]
            | select(.tier=="ALWAYS_FREE")
            | [
                .name,
                (.limits // "N/A"),
                (.notes  // "â€”")
              ]
            | @tsv
          ' free-tier.json | while IFS=$'\t' read -r NAME LIMITS NOTES; do
            echo "| ${NAME} | ${LIMITS} | ${NOTES} |" >> "${OUT_PATH}"
          done

          echo "" >> "${OUT_PATH}"
          echo "### æ³¨æ„äº‹é …" >> "${OUT_PATH}"
          echo "- åˆ©ç”¨é‡ãŒå¸¸æ™‚ç„¡æ–™æž ã‚’**è¶…ãˆã‚‹ã¨èª²é‡‘**ã•ã‚Œã¾ã™ã€‚" >> "${OUT_PATH}"
          echo "- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°ã‚„æ¡ä»¶ï¼ˆä¾‹ï¼šã‚¯ã‚¨ãƒªå›žæ•°ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ï¼‰ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚" >> "${OUT_PATH}"
          echo "- 12ã‹æœˆç„¡æ–™æž ã¨å¸¸æ™‚ç„¡æ–™æž ã¯åˆ¥ã€‚**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‹ã‚‰12ã‹æœˆã‚’éŽãŽã¦ã‚‚å¸¸æ™‚ç„¡æ–™æž ã¯ç¶™ç¶š**ã—ã¾ã™ï¼ˆåˆ¶é™å†…åˆ©ç”¨ï¼‰ã€‚" >> "${OUT_PATH}"
          echo "" >> "${OUT_PATH}"
          echo "ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã¯GitHub Actionsã§æ¯Žæ—¥è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ï¼‰" >> "${OUT_PATH}"

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${OUT_PATH}" zenn/books/.keep zenn/images/.keep
          git commit -m "chore: auto-update always-free list"
          git push
